trigger:
  - main

variables:
- group: backend-vars

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self

  - script: |
      set -ex
      echo "Usando SAM CLI preinstalado:"
      sam --version
    displayName: 'Ver versión AWS SAM CLI'

  - task: AWSShellScript@1
    displayName: 'SAM Build & Deploy'
    inputs:
      awsCredentials: 'aws-reto-cloud-SantiagoG'
      regionName: 'us-east-1'
      scriptType: 'inline'
      inlineScript: |
        set -ex

        echo "PWD (raíz del repo):"
        pwd
        echo "Contenido de la raíz:"
        ls -la

        # 1) Entrar a la carpeta backend (donde tú dijiste que está template.yml)
        cd backend

        echo "PWD dentro de backend:"
        pwd
        echo "Contenido de backend:"
        ls -la

        # 2) Comprobar que existe el template
        if [ ! -f template.yml ]; then
          echo "ERROR: No se encontró template.yml en la carpeta backend"
          exit 1
        fi

        # 3) Build usando el template
        sam build -t template.yml

        # 4) Deploy usando el mismo template
        sam deploy \
          -t template.yml \
          --stack-name reto-cloud-backend \
          --region us-east-1 \
          --no-confirm-changeset \
          --resolve-s3 \
          --capabilities CAPABILITY_IAM \
          --parameter-overrides \
            DbHost=$(DB_HOST) \
            DbUser=$(DB_USER) \
            DbPassword=$(DB_PASSWORD) \
            DbName=$(DB_NAME) \
            DbPort=$(DB_PORT) \
            PrivateSubnet1=$(PRIVATE_SUBNET_1) \
            PrivateSubnet2=$(PRIVATE_SUBNET_2) \
            LambdaSecurityGroup=$(LAMBDA_SG)
